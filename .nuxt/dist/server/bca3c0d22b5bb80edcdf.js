exports.ids=[42],exports.modules={119:function(t,e){t.exports={h1:"h1_17sSx",h2:"h2_29h8C",h3:"h3_pcROM",h4:"h4_-wXkD",h5:"h5_3RgCW",h6:"h6_1UKhu","skeleton-loading":"skeleton-loading_3wvbo",skeletonLoading:"skeleton-loading_3wvbo",skeleton:"skeleton_3yQuF"}},120:function(t,e){t.exports={image:"image_2HoYb",border:"border_fvHwL",bg:"bg_OU_Qk","skeleton-loading":"skeleton-loading_W_WF0",skeletonLoading:"skeleton-loading_W_WF0",skeleton:"skeleton_3dcSj"}},121:function(t,e){t.exports={paragraph:"paragraph_1OWG2","skeleton-loading":"skeleton-loading_3Hgsp",skeletonLoading:"skeleton-loading_3Hgsp",skeleton:"skeleton_2H5RA"}},122:function(t,e){t.exports={list:"list_rxwoA","skeleton-loading":"skeleton-loading_hADmg",skeletonLoading:"skeleton-loading_hADmg",skeleton:"skeleton_3a9b2"}},123:function(t,e){t.exports={delimiter:"delimiter_3ksS5","skeleton-loading":"skeleton-loading_1lzJ0",skeletonLoading:"skeleton-loading_1lzJ0",skeleton:"skeleton_jIhh3"}},124:function(t,e){t.exports={checklist:"checklist_35Trq","skeleton-loading":"skeleton-loading_2NnRn",skeletonLoading:"skeleton-loading_2NnRn",skeleton:"skeleton_RKAJg"}},125:function(t,e){t.exports={link:"link_1cdqF",content:"content_31mUQ",logo:"logo_3t3p1","skeleton-loading":"skeleton-loading_Q1SbS",skeletonLoading:"skeleton-loading_Q1SbS",skeleton:"skeleton_13H0b"}},126:function(t,e){t.exports={video:"video_1Ktgc",wrap:"wrap_3iFmj","skeleton-loading":"skeleton-loading_DCN-u",skeletonLoading:"skeleton-loading_DCN-u",skeleton:"skeleton_1YNsK"}},127:function(t,e){t.exports={music:"music_1aU_y","skeleton-loading":"skeleton-loading_3yST_",skeletonLoading:"skeleton-loading_3yST_",skeleton:"skeleton_3Zagh"}},128:function(t,e){t.exports={baidu:"baidu_3yD19",logo:"logo_3fZIb",content:"content_2vYlq","skeleton-loading":"skeleton-loading_2_Vpm",skeletonLoading:"skeleton-loading_2_Vpm",skeleton:"skeleton_Yoxzs"}},129:function(t,e){t.exports={vote:"vote_1AMl_",selected:"selected_1h5XP",count:"count_3bLzQ",active:"active_2YTSY","skeleton-loading":"skeleton-loading_2BuFl",skeletonLoading:"skeleton-loading_2BuFl",skeleton:"skeleton_3B0sO"}},141:function(t,e,n){"use strict";e.a={beforeMount(){const t=()=>{this.$store.getters.isMine(this.$route.params.slug)||this.$router.replace({name:this.$route.name,params:{slug:this.$store.state.user.slug}})};if(this.$store.state.isAuth)return void t();const e=this.$watch("$store.state.isAuth",n=>{n&&(t(),e())})}}},144:function(t,e,n){"use strict";var r={name:"JsonHeader",props:{item:{type:Object,required:!0}},render(t){const e=this.item.data.level;return t("h"+this.item.data.level,{class:this.$style[`h${e}`],domProps:{innerHTML:this.item.data.text}})}},o=n(1);var header=Object(o.a)(r,void 0,void 0,!1,(function(t){var e=n(180);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"0447caaa").exports,l={name:"JsonImage",props:{item:{type:Object,required:!0}}};var c=Object(o.a)(l,(function(){var t,e,n=this,r=n.$createElement,o=n._self._c||r;return o("div",{class:n.$style.image},[n._ssrNode("<div"+n._ssrClass(null,[(t={},t[n.$style.border]=n.item.data.withBorder,t),(e={},e[n.$style.bg]=n.item.data.withBackground,e)])+">","</div>",[n._ssrNode("<div>","</div>",[o("VImg",{attrs:{src:n.item.data.file.url,stretched:n.item.data.stretched,width:n.item.data.file.width,height:n.item.data.file.height}})],1)]),n._ssrNode(" "+(n.item.data.caption?"<p>"+n._ssrEscape(n._s(n.item.data.caption))+"</p>":"\x3c!----\x3e"))],2)}),[],!1,(function(t){var e=n(181);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"1df9eca6").exports,d={name:"JsonParagraph",props:{item:{type:Object,required:!0}}};var h=Object(o.a)(d,(function(){var t=this.$createElement;return(this._self._c||t)("p",{class:this.$style.paragraph,domProps:{innerHTML:this._s(this.item.data.text.replace(/\n/g,"<br>"))}},[])}),[],!1,(function(t){var e=n(182);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"18788980").exports,m={name:"JsonList",props:{item:{type:Object,required:!0}}};var _=Object(o.a)(m,(function(){var t=this,e=t.$createElement;return(t._self._c||e)("div",{class:t.$style.list},[t._ssrNode("ordered"===t.item.data.style?"<ol>"+t._ssrList(t.item.data.items,(function(li,e){return"<li>"+t._s(li)+"</li>"}))+"</ol>":"<ul>"+t._ssrList(t.item.data.items,(function(li,e){return"<li>"+t._s(li)+"</li>"}))+"</ul>")])}),[],!1,(function(t){var e=n(183);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"86987c88").exports,f={name:"JsonDelimiter",props:{item:{type:Object,required:!0}}};var v=Object(o.a)(f,(function(){var t=this.$createElement;return(this._self._c||t)("div",{class:this.$style.delimiter},[])}),[],!1,(function(t){var e=n(184);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"9239394e").exports,$={name:"JsonChecklist",props:{item:{type:Object,required:!0}}};var y=Object(o.a)($,(function(){var t=this,e=t.$createElement;return(t._self._c||e)("ul",{class:t.$style.checklist},[t._ssrNode(t._ssrList(t.item.data.items,(function(option,e){return"<li>"+(option.checked?"<i></i>":"<em></em>")+" <div>"+t._s(option.text)+"</div></li>"})))])}),[],!1,(function(t){var e=n(185);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"169c3110").exports,k={name:"JsonLink",props:{item:{type:Object,required:!0}}};var x=Object(o.a)(k,(function(){var t=this,e=t.$createElement;return(t._self._c||e)("div",{class:t.$style.link},[t._ssrNode('<a target="_blank"'+t._ssrAttr("href",t.item.data.link)+">"+(t.item.data.meta.image&&t.item.data.meta.image.url?"<img"+t._ssrAttr("src",t.item.data.meta.image.url)+' width="65" height="65"'+t._ssrClass(null,t.$style.logo)+">":"\x3c!----\x3e")+" <div"+t._ssrClass(null,t.$style.content)+"><h3>"+t._ssrEscape(t._s(t.item.data.meta.title))+"</h3> <p>"+t._ssrEscape(t._s(t.item.data.meta.description))+"</p> <span>"+t._ssrEscape(t._s(t.item.data.link.replace(/https?:\/\//,"")))+"</span></div></a>")])}),[],!1,(function(t){var e=n(186);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"98a699d0").exports,w={name:"JsonVideo",props:{item:{type:Object,required:!0}}};var video=Object(o.a)(w,(function(){var t=this,e=t.$createElement;return(t._self._c||e)("div",{class:t.$style.video},[t._ssrNode("<div"+t._ssrClass(null,t.$style.wrap)+"><iframe"+t._ssrAttr("src",t.item.data.embed)+' scrolling="no" border="0" frameborder="no" framespacing="0" allowtransparency="true" allowfullscreen="allowfullscreen"></iframe></div> '+(t.item.data.caption?"<p>"+t._ssrEscape(t._s(t.item.data.caption))+"</p>":"\x3c!----\x3e"))])}),[],!1,(function(t){var e=n(187);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"74cde4cd").exports,C={name:"JsonMusic",props:{item:{type:Object,required:!0}}};var j=Object(o.a)(C,(function(){var t=this,e=t.$createElement;return(t._self._c||e)("div",{class:t.$style.music},[t._ssrNode("<iframe"+t._ssrAttr("src",t.item.data.embed)+' scrolling="no" border="0" frameborder="no" framespacing="0" allowtransparency="true" allowfullscreen="allowfullscreen" width="330" height="86"></iframe> '+(t.item.data.caption?"<p>"+t._ssrEscape(t._s(t.item.data.caption))+"</p>":"\x3c!----\x3e"))])}),[],!1,(function(t){var e=n(188);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"3c9bd977").exports,M={name:"JsonBaidu",props:{item:{type:Object,required:!0},reward:{type:Boolean,required:!0}}};var S=Object(o.a)(M,(function(){var t=this,e=t.$createElement;return(t._self._c||e)("div",{class:t.$style.baidu},[t._ssrNode("<a"+t._ssrAttr("href",t.item.data.url)+' target="_blank"><i'+t._ssrClass("iconfont ic-baidu-cloud",t.$style.logo)+"></i> <div"+t._ssrClass(null,t.$style.content)+">"+(0===t.item.data.visit_type||t.reward?t._ssrEscape(" 密码："+t._s(t.item.data.password)+" "):"\n        密码投食后可见\n      ")+"</div></a>")])}),[],!1,(function(t){var e=n(189);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"b0eaa326").exports,E={name:"JsonVote",props:{item:{type:Object,required:!0},vote:{type:Array,required:!0},slug:{type:String,required:!0}},data:()=>({selected:[],submitting:!1,voted:!1,stat:[],maxCount:0}),watch:{vote(t){this.selected=t.map(t=>t),t.length&&(this.voted=!0,this.getVoteStat())}},methods:{getVoteStat(){this.$axios.$get("v1/pin/vote_stat",{params:{slug:this.slug}}).then(data=>{this.stat=data,this.maxCount=Math.max(...Object.values(this.stat))}).catch(()=>{})},handleSelect(option){const{selected:t,voted:e}=this;if(e)return;const n=t.indexOf(option.id);if(~n)return void t.splice(n,1);const r=this.item.data.max_select;r<=t.length?1===r&&t.splice(n,1,option.id):t.push(option.id)},checkSelected(option){return~this.selected.indexOf(option.id)},submit(){this.submitting||this.voted||(this.selected.length?this.item.data.expired_at&&1e3*this.item.data.expired_at<Date.now()?this.$toast.info("投票已截止"):(this.submitting=!0,this.$axios.$post("v1/social/vote",{pin_slug:this.slug,answer_hash:this.selected}).then(()=>{this.$toast.success("投票成功"),this.voted=!0,this.getVoteStat()}).catch(t=>{this.$toast.error(t.message)}).finally(()=>{this.submitting=!1})):this.$toast.info("至少选择一项"))},computeItemStyle(option,t){const e=this.stat[option.id]||0;return{width:e?`${75*e/this.maxCount}%`:"0%",backgroundColor:this.getRandomColor(t)}},getRandomColor:t=>["rgba(255,170,170,.5)","rgba(255,148,39,.5)","rgba(252,196,25,.5)","rgba(32,201,151,.5)","rgba(18,183,245,.5)","rgba(173,181,189,.5)"][t%6]}};class L{constructor({minLength:t,shareLink:e}={}){this.config={org:"calibur",appendStr:"文章著作权归作者所有，任何形式的转载都请联系作者获得授权并注明出处。",minLength:t||140,shareLink:e||window.location.href.split("?")[0]},this.prefix={org:"来源",link:"链接",author:"作者"}}bind(t,{minLength:e,authorNickname:n,shareLink:r,appendStr:o}={}){t.addEventListener("copy",t=>{const l=e||this.config.minLength,c=r||this.config.shareLink,d=o||this.config.appendStr,h=window.getSelection().getRangeAt(0),m=this.getHTMLParser("");m&&m.appendChild(h.cloneContents());const _=h.toString().trim(),f=m?m.innerHTML:this.getRangeHtml(h);if(document.createElement("div").innerHTML=f,_.length>=l){const e=this.getCopyHtml(f,c,n,d),r=this.getCopyText(_,c,n,d);void 0===t.clipboardData&&this.hack(e,h);try{t.clipboardData.setData("text/plain",r),t.clipboardData.setData("text/html",e),t.preventDefault()}catch(t){this.hack(e,h)}}})}abort(t){t.addEventListener("copy",t=>(t.stopPropagation(),t.preventDefault(),t.cancelBubble=!1,!1))}hack(text,t){const e=document.createElement("div");e.innerHTML=text,e.style.position="fixed",e.style.left="-9999px",document.body.appendChild(e),window.getSelection().selectAllChildren(e),setTimeout(()=>{try{window.getSelection().removeAllRanges(),window.getSelection().addRange(t)}catch(t){}document.body.removeChild(e)},0)}getCopyHtml(html,t,e,n){return`<div><div>${html}</div>${this.getExtraCopyright(t,e,n).join("<br>")}</div>`}getCopyText(text,t,e,n){return text+this.getExtraCopyright(t,e,n).join("\n")}getExtraCopyright(t,e,n){return e?["","",`${this.prefix.author}：${e}`,`${this.prefix.link}：${t}`,`${this.prefix.org}：${this.config.org}`,n]:["","",`${this.prefix.link}：${t}`,`${this.prefix.org}：${this.config.org}`,n]}getRangeHtml(text){const div=document.createElement("div");return div.appendChild(text.cloneContents()),div.outerHTML}getHTMLParser(t){try{return(new window.DOMParser).parseFromString(t,"text/html").body}catch(e){const n=document.implementation.createHTMLDocument("");return n.body.innerHTML=t,n.body}}}var O={name:"JsonContent",components:{"v-header":header,"v-image":c,"v-paragraph":h,"v-list":_,"v-delimiter":v,"v-checklist":y,"v-link":x,"v-video":video,"v-music":j,"v-baidu":S,"v-vote":Object(o.a)(E,(function(){var t,e=this,n=e.$createElement;return(e._self._c||n)("div",{class:e.$style.vote},[e._ssrNode("<div><header>"+e._ssrEscape("投票（"+e._s(1===e.item.data.max_select?"单选":"最多选"+e.item.data.max_select+"个")+"）")+"</header> <ul>"+e._ssrList(e.item.data.items,(function(option,t){var n;return"<li"+e._ssrClass("oneline",((n={})[e.$style.selected]=e.checkSelected(option),n))+"><span"+e._ssrClass(null,e.$style.count)+e._ssrStyle(null,e.computeItemStyle(option,t),null)+">"+e._s(e.stat[option.id]?e.stat[option.id]+"票&nbsp;&nbsp;":"")+"</span> <span>"+e._s(t+1+". "+option.text)+"</span> <i></i></li>"}))+"</ul> <footer><span>"+e._ssrEscape("截止时间："+e._s(e.item.data.expired_at?e.$utils.timeAgo(e.item.data.expired_at):"无限期"))+"</span> <button"+e._ssrClass(null,(t={},t[e.$style.active]=e.selected.length&&!e.voted,t))+">"+e._ssrEscape("\n        "+e._s(e.submitting?"提交中":e.voted?"已投过票":"确认")+"\n      ")+"</button></footer></div>")])}),[],!1,(function(t){var e=n(190);e.__inject__&&e.__inject__(t),this.$style=e.locals||e}),null,"09c65e08").exports},props:{content:{required:!0,type:Array},reward:{type:Boolean,default:!1},vote:{type:Array,default:()=>[]},slug:{type:String,default:""}},mounted(){(new L).bind(this.$el)}},T=Object(o.a)(O,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("section",{staticClass:"json-content"},t._l(t.content,(function(e,r){return n("v-"+e.type,{key:r,tag:"component",attrs:{item:e,reward:t.reward,vote:t.vote,slug:t.slug}})})),1)}),[],!1,null,null,"db874c02");e.a=T.exports},180:function(t,e,n){"use strict";n.r(e);var r=n(119),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},181:function(t,e,n){"use strict";n.r(e);var r=n(120),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},182:function(t,e,n){"use strict";n.r(e);var r=n(121),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},183:function(t,e,n){"use strict";n.r(e);var r=n(122),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},184:function(t,e,n){"use strict";n.r(e);var r=n(123),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},185:function(t,e,n){"use strict";n.r(e);var r=n(124),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},186:function(t,e,n){"use strict";n.r(e);var r=n(125),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},187:function(t,e,n){"use strict";n.r(e);var r=n(126),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},188:function(t,e,n){"use strict";n.r(e);var r=n(127),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},189:function(t,e,n){"use strict";n.r(e);var r=n(128),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},190:function(t,e,n){"use strict";n.r(e);var r=n(129),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},192:function(t,e,n){t.exports=n.p+"img/e82d3e7.png"},215:function(t,e){t.exports={undefined:void 0}},216:function(t,e){t.exports={undefined:void 0}},217:function(t,e){t.exports={undefined:void 0}},218:function(t,e){t.exports={undefined:void 0}},219:function(t,e){t.exports={undefined:void 0}},220:function(t,e){t.exports={undefined:void 0}},308:function(t,e,n){"use strict";n.r(e);var r=n(215),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},309:function(t,e){t.exports={undefined:void 0}},310:function(t,e,n){"use strict";n.r(e);var r=n(216),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},311:function(t,e,n){"use strict";n.r(e);var r=n(217),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},312:function(t,e,n){"use strict";n.r(e);var r=n(218),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},313:function(t,e,n){"use strict";n.r(e);var r=n(219),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},314:function(t,e,n){"use strict";n.r(e);var r=n(220),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a},340:function(t,e,n){"use strict";n.r(e);var r=n(77),o=n.n(r),l=n(29),c={name:"MessageMenu",props:{slug:{type:String,required:!0}},data:()=>({menuWatcher:null,timeWatcher:null,friends:[]}),computed:{menu(){return this.$store.state.messageMenu.list}},mounted(){this.menuWatcher=this.$watch("$store.state.mailbox.unread_message_total",(t,e)=>{t>e&&!this.$store.state.socket.isConnected&&this.$store.dispatch("getMessageMenu")}),this.timeWatcher=this.$watch("$store.state.messageMenu.time",()=>{this.$store.dispatch("updateMessageMenu")}),this.$store.dispatch("updateMessageMenu"),this.menu.length&&this.$store.state.socket.isConnected||this.initChatRoom()},beforeDestroy(){this.menuWatcher&&this.menuWatcher(),this.timeWatcher&&this.timeWatcher()},methods:{async initChatRoom(){const t=o.a.service({target:this.$el});await this.getUserFriends(),await this.$store.dispatch("getMessageMenu"),t.close()},async getUserFriends(){const t=()=>{Object(l.getUserRelation)({$axios:this.$axios,slug:this.slug,relation:"friend"}).then(data=>{data.result.forEach(t=>this.$cache.setUserSessionStore(t)),this.friends=data.result,sessionStorage.setItem("user-friends-list",JSON.stringify(data.result))})};try{const e=sessionStorage.getItem("user-friends-list");if(!e)return void await t();const n=JSON.parse(e);n.forEach(t=>this.$cache.setUserSessionStore(t)),this.friends=n}catch(e){await t()}},deleteChannel(t){this.$axios.$post("v1/message/delete_channel",{channel:t.channel}).then(()=>{this.$store.commit("DELETE_MESSAGE_MENU",t.channel)}).catch(()=>{})},emitClick(t){this.$emit("open",t)}}},d=n(1);var h=Object(d.a)(c,(function(){var t=this,e=t.$createElement;return(t._self._c||e)("ul",{staticClass:"message-menu"},[t._ssrNode(t._ssrList(t.menu,(function(e){return'<li><div class="room-item clearfix">'+(e.user.avatar?"<img"+t._ssrAttr("src",t.$resize(e.user.avatar,{width:42}))+t._ssrAttr("alt",e.user.nickname)+' class="avatar">':"\x3c!----\x3e")+' <div class="content"><p class="nickname oneline">'+t._s(e.user.nickname)+'</p> <div class="footer">'+(e.count?'<div class="read-badge">'+t._ssrEscape(t._s(e.count))+"</div>":"\x3c!----\x3e")+'</div></div></div> <div class="close">\n      ×\n    </div></li>'})))])}),[],!1,(function(t){var e=n(308);e.__inject__&&e.__inject__(t)}),null,"04b91794").exports,m=n(78),_=n.n(m),f=(n(309),{name:"ChatAvatar",components:{UserAvatar:n(95).a},props:{item:{type:Object,required:!0}},computed:{isMine(){return this.$store.state.user.slug===this.item.slug}}});var v=Object(d.a)(f,(function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"chat-avatar",class:[this.isMine?"chat-avatar-mine":"chat-avatar-other"]},[e("UserAvatar",{attrs:{user:this.item,size:36}})],1)}),[],!1,(function(t){var e=n(310);e.__inject__&&e.__inject__(t)}),null,"630a9f70").exports,$={name:"ChatMessage",components:{JsonContent:n(144).a},props:{item:{type:Object,required:!0}}};var y=Object(d.a)($,(function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"chat-message"},[e("JsonContent",{attrs:{content:this.item.content}})],1)}),[],!1,(function(t){var e=n(311);e.__inject__&&e.__inject__(t)}),null,"959e5200").exports,k=n(79),x=n.n(k),w=n(80),C=n.n(w),j={name:"VScroll",props:{probeType:{type:Number,default:1},click:{type:Boolean,default:!0},data:{type:Array,default:null},scrollX:{type:Boolean,default:!1}},watch:{data(){this.refresh()}},mounted(){setTimeout(()=>{this._initScroll()},20)},beforeDestroy(){this.scroll&&this.scroll.destroy()},methods:{_initScroll(){this.$refs.wrapper&&(x.a.use(C.a),this.scroll=new x.a(this.$refs.wrapper,{probeType:this.probeType,click:this.click,fade:!0,scrollX:this.scrollX,scrollY:!this.scrollX,mouseWheel:{invert:!1,speed:30,easeTime:300}}),this.scroll.on("scrollEnd",()=>{this.scroll.y>-50&&this.$emit("top"),this.scroll.y<=this.scroll.maxScrollY+50&&this.$emit("bottom")}))},enable(){this.scroll&&this.scroll.enable()},disable(){this.scroll&&this.scroll.disable()},refresh(){return new Promise(t=>{this.$nextTick(()=>{setTimeout(()=>{this.scroll&&this.scroll.refresh(),this.$nextTick(()=>{t()})},20)})})},scrollTo(){setTimeout(()=>{this.scroll&&this.scroll.scrollTo.apply(this.scroll,arguments)},0)},scrollToElement(){setTimeout(()=>{this.scroll&&this.scroll.scrollToElement.apply(this.scroll,arguments)},0)}}};var M={name:"MessageRoom",components:{Scroll:Object(d.a)(j,(function(){var t=this.$createElement;return(this._self._c||t)("div",{ref:"wrapper",staticClass:"scroll-warp"},[this._t("default")],2)}),[],!1,(function(t){var e=n(312);e.__inject__&&e.__inject__(t)}),null,"2a757871").exports,ChatRoom:_.a},props:{mailto:{type:String,required:!0},name:{type:String,required:!0},slug:{type:String,required:!0}},data:()=>({message:"",target:null,chatsHeight:0,stopWatcher:null,noMore:!1}),computed:{query(){return{channel:this.mailto,$axios:this.$axios}},avatarComp:()=>v,messageComps:()=>({message:y}),computeHelperTxt:()=>"undefined"==typeof window?"":/windows/.test(window.navigator.userAgent.toLocaleLowerCase())?"按下Ctrl+Enter换行":"按下Cmd+Enter换行"},watch:{$route(){this.initRoom()}},beforeMount(){this.$store.state.messageRoom[this.mailto]||this.$store.commit("INIT_MESSAGE_ROOM",this.mailto)},mounted(){this.initRoom()},methods:{initRoom(){this.$nextTick(async()=>{this.$refs.room&&this.$refs.room.clearMessage(),this.$refs.loader&&this.$refs.loader.forceCallback(),await this.$refs.loader.initData({is_up:1}),await this.$refs.loader.loadMore({force:!0}),this.clearUnreadCount(),this.watchMessageLoop()})},clearUnreadCount(){const menu=this.$store.state.messageMenu.list.filter(t=>t.channel===this.mailto)[0];!menu||menu.count<=0||(this.$axios.$post("v1/message/clear_channel",{channel:this.mailto}),this.$store.commit("CLEAR_NOTIFICATION",{channel:this.mailto,count:menu.count}))},watchMessageLoop(){this.stopWatcher&&this.stopWatcher();const t=this,e=t.mailto;this.stopWatcher=this.$watch((function(){return t.$store.state.messageRoom[t.mailto].time}),(function(){if(e!==t.mailto)return void this.stopWatcher();const n=t.$store.state.messageRoom[t.mailto].data;t.$store.state.socket.isConnected&&n?t.appendMessage(n):t.$refs.loader.loadMore({force:!0}),t.screenScroll(),t.clearUnreadCount()}))},handleScrollUp(){this.noMore||this.$refs.loader.loadBefore({force:!0})},handleMessageLoad({data:data,params:t}){0!==t.is_up||data.result.length||(this.noMore=!0),this.$nextTick(()=>{1===t.is_up?(data.result.map(t=>t).reverse().map(t=>{this.appendMessage(t,!1)}),this.screenScroll(!1)):(data.result.map(t=>{this.appendMessage(t)}),this.screenScroll())})},screenScroll(t=!0){this.$refs.scroll&&this.$refs.scroll.refresh().then(()=>{const e=this.$refs.room.$el.clientHeight,n=this.$refs.wrap.clientHeight;e<n||(this.lastChatsHeight&&!t?this.$refs.scroll.scrollTo(0,this.lastChatsHeight-e):this.$refs.scroll.scrollTo(0,n-e),this.lastChatsHeight=e)})},appendMessage(t,e=!0){this.$refs.room.addMessage({id:t.id,type:"message",float:t.user.slug===this.slug?"right":"left",color:2===t.user.sex?{bg:"#ff6881",text:"#fff"}:{bg:"#12b7f5",text:"#fff"},data:t},e)},handleAddBubble(){if(!this.message.trim())return;const t=[{type:"paragraph",data:{text:this.message.trim()}}],e=Math.random().toString(10).substring(3,6);this.appendMessage({id:e,user:this.$store.state.user,content:t,created_at:Date.now()}),this.screenScroll(),this.message="",this.$axios.$post("v1/message/send",{channel:this.mailto,content:t}).then(t=>{this.$refs.room.updateMessage(e,{id:t.id}),this.$refs.loader.append(t)}).catch(()=>{this.$refs.room.updateMessage(e,{status:"error"})})},handleNewLine(){this.message&&(this.message+="\n")}}};var S=Object(d.a)(M,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"room"},[t._ssrNode('<div class="room-header">'+t._ssrEscape("\n    "+t._s(t.name)+"\n  ")+"</div> "),n("FlowLoader",{ref:"loader",staticClass:"room-body",attrs:{func:"getUserMessage",type:"sinceId",query:t.query,callback:t.handleMessageLoad,"callback-once":!1,"cache-timeout":86400,auto:0},scopedSlots:t._u([{key:"default",fn:function(e){var r=e.flow;return n("div",{ref:"wrap",staticClass:"room-chats"},[n("Scroll",{ref:"scroll",attrs:{data:r},on:{top:t.handleScrollUp}},[n("ChatRoom",{ref:"room",attrs:{"avatar-component":t.avatarComp,"message-components":t.messageComps}})],1)],1)}}])}),t._ssrNode(' <div class="room-footer"><textarea maxlength="500" placeholder="say it...">'+t._ssrEscape(t._s(t.message))+'</textarea> <div class="helper"><span>'+t._ssrEscape(t._s(t.computeHelperTxt))+"</span> <button>\n        发送\n      </button></div></div>")],2)}),[],!1,(function(t){var e=n(313);e.__inject__&&e.__inject__(t)}),null,"174bc1b2").exports,E=n(141),L={name:"UserMessage",components:{MessageMenu:h,MessageRoom:S},mixins:[n(90).a,E.a],props:{slug:{type:String,required:!0}},computed:{mailto(){return this.$route.query.mailto},name(){return this.$route.query.name}},methods:{handleOpen(t){this.$router.push(this.$alias.user(this.slug,`message/?mailto=${t.channel}&name=${t.user.nickname}`))}}};var O=Object(d.a)(L,(function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",{attrs:{id:"user-message"}},[r("ElRow",{staticClass:"column-wrap"},[r("ElCol",{attrs:{span:6}},[r("MessageMenu",{attrs:{slug:t.slug},on:{open:t.handleOpen}}),t._v("\n       \n    ")],1),t._v(" "),r("ElCol",{attrs:{span:18}},[r("div",{staticClass:"room-adjust"},[t.mailto?r("MessageRoom",{attrs:{mailto:t.mailto,name:t.name,slug:t.slug}}):r("div",{staticClass:"need-pick"},[r("img",{attrs:{src:n(192)}}),t._v(" "),r("p",[t._v("未选择聊天")])])],1)])],1)],1)}),[],!1,(function(t){var e=n(314);e.__inject__&&e.__inject__(t)}),null,"1992ef02");e.default=O.exports},86:function(t,e){t.exports={undefined:void 0}},90:function(t,e,n){"use strict";e.a={beforeMount(){this.$channel.$when("user-not-sign",()=>{this.$toast.error("继续操作前请先登录").then(()=>{window.location.href=this.$alias.sign()})})}}},95:function(t,e,n){"use strict";var r={name:"UserAvatar",props:{user:{type:Object,required:!0},avatar:{type:String,default:""},size:{type:Number,default:40},disabled:{type:Boolean,default:!1}}},o=n(1);var component=Object(o.a)(r,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return t.disabled?n("div",{staticClass:"user-avatar",style:{width:t.size+"px",height:t.size+"px"}},[n("VImg",{attrs:{radius:"50%",src:t.avatar||t.user.avatar,width:t.size,height:t.size,alt:t.user.nickname}})],1):n("NLink",{staticClass:"user-avatar",style:{width:t.size+"px",height:t.size+"px"},attrs:{to:t.$alias.user(t.user.slug),target:"_blank"}},[n("VImg",{attrs:{radius:"50%",src:t.avatar||t.user.avatar,width:t.size,height:t.size,alt:t.user.nickname}})],1)}),[],!1,(function(t){var e=n(96);e.__inject__&&e.__inject__(t)}),null,"8c0ebd70");e.a=component.exports},96:function(t,e,n){"use strict";n.r(e);var r=n(86),o=n.n(r);for(var l in r)"default"!==l&&function(t){n.d(e,t,(function(){return r[t]}))}(l);e.default=o.a}};