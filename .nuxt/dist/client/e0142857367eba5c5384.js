(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{318:function(e,t,o){"use strict";o(31),o(51),o(55),o(52),o(54);var r=o(2),n=o(319);t.a={data:()=>({uploadHeaders:{key:"",token:""},uploadConfig:{max:5},uploadImageLimit:20,imageUploadAccept:["image/jpeg","image/png","image/jpg"].join(", "),imageUploadAction:"https://upload.qiniup.com",imagePrefix:"https://m1.calibur.tv/",getUpTokenTimer:0,uploadPending:0,uploadImageTotal:0,uploadImageList:[]}),computed:{currentUser(){return this.$store.state.user},isAuth(){return this.$store.state.isAuth}},mounted(){this.isAuth?this.initUpToken():this.$channel.$when("user-signed",()=>{this.initUpToken()})},beforeDestroy(){this.getUpTokenTimer&&clearInterval(this.getUpTokenTimer)},methods:{initUpToken(){this.getUpToken(),this.getUpTokenTimer=setInterval(()=>{this.getUpToken()},18e5)},getUpToken(){var e=this;return Object(r.a)((function*(){var t=e.$cookie.get("UPLOAD-TOKEN");t?e.uploadHeaders.token=e.$cookie.get("UPLOAD-TOKEN"):(t=yield Object(n.a)(e),e.uploadHeaders.token=t,e.$cookie.set("UPLOAD-TOKEN",t,{expires:new Date((new Date).getTime()+3e6)}))}))()},handleImageUploadError(e,t){this.uploadImageList.forEach((o,r)=>{o.uid===t.uid&&(this.uploadPending--,this.uploadImageList.splice(r,1),console.log(e))}),this.$toast.error("图片：".concat(t.name," 上传失败"))},handleImageUploadRemove(e){this.uploadImageList.forEach((t,o)=>{t.uid===e.uid&&(this.uploadImageList.splice(o,1),this.uploadImageTotal--)})},handleImageUploadSuccess(e,t){this.uploadImageList.forEach((o,r)=>{o.uid===t.uid&&(this.uploadImageList[r]=Object.assign(o,{data:e.data,status:"success",url:this.$resize("".concat(this.imagePrefix).concat(e.data.url),{width:100})}))}),this.uploadImageTotal++,this.uploadPending--},handleImageUploadExceed(){this.$toast.info("最多还能上传".concat(this.uploadImageLimit-this.uploadImageTotal,"张图片"))},handleImageUploadBefore(e){if(!this.isAuth)return this.$channel.$emit("sign-in"),!1;if(!this.imageUploadAccept.split(", ").includes(e.type))return this.$toast.error("仅支持上传".concat(this.imageUploadAccept.replace(/image\//g,"").replace(/, /g,"、"),"格式的图片")),!1;if(this.uploadConfig.max&&this.uploadConfig.max<e.size/1024/1024)return this.$toast.error("图片大小不能超过 ".concat(this.uploadConfig.max,"MB!")),!1;return this.uploadHeaders.key=(e=>{var{slug:t,file:o}=e;return"".concat(t,"/").concat((new Date).getTime(),"-").concat(Math.random().toString(36).substring(3,6),".").concat(o.type.split("/").pop())})({slug:this.currentUser.slug,file:e}),this.uploadImageList.push({name:e.name,percentage:0,raw:e,size:e.size,status:"uploading",errMsg:"",uid:e.uid}),this.uploadPending++,!0},resetUploaderStatus(){this.uploadImageList=[],this.uploadImageTotal=0,this.uploadPending=0}}}},319:function(e,t,o){"use strict";o.d(t,"a",(function(){return r})),o.d(t,"b",(function(){return n}));o(51);var r=e=>e.$axios.$get("v1/image/uptoken"),n=(e,t)=>e.$axios.$post("https://up.qbox.me",t,{"Content-Type":"multipart/form-data"})},324:function(e,t,o){e.exports=function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)o.d(r,n,function(t){return e[t]}.bind(null,n));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(object,e){return Object.prototype.hasOwnProperty.call(object,e)},o.p="/dist/",o(o.s=116)}({0:function(e,t,o){"use strict";function r(e,t,o,r,n,l,d,c){var m,h="function"==typeof e?e.options:e;if(t&&(h.render=t,h.staticRenderFns=o,h._compiled=!0),r&&(h.functional=!0),l&&(h._scopeId="data-v-"+l),d?(m=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),n&&n.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(d)},h._ssrRegister=m):n&&(m=c?function(){n.call(this,this.$root.$options.shadowRoot)}:n),m)if(h.functional){h._injectStyles=m;var f=h.render;h.render=function(e,t){return m.call(t),f(e,t)}}else{var v=h.beforeCreate;h.beforeCreate=v?[].concat(v,m):[m]}return{exports:e,options:h}}o.d(t,"a",(function(){return r}))},116:function(e,t,o){"use strict";o.r(t);var r=function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("label",{staticClass:"el-radio",class:[e.border&&e.radioSize?"el-radio--"+e.radioSize:"",{"is-disabled":e.isDisabled},{"is-focus":e.focus},{"is-bordered":e.border},{"is-checked":e.model===e.label}],attrs:{role:"radio","aria-checked":e.model===e.label,"aria-disabled":e.isDisabled,tabindex:e.tabIndex},on:{keydown:function(t){if(!("button"in t)&&e._k(t.keyCode,"space",32,t.key,[" ","Spacebar"]))return null;t.stopPropagation(),t.preventDefault(),e.model=e.isDisabled?e.model:e.label}}},[o("span",{staticClass:"el-radio__input",class:{"is-disabled":e.isDisabled,"is-checked":e.model===e.label}},[o("span",{staticClass:"el-radio__inner"}),o("input",{directives:[{name:"model",rawName:"v-model",value:e.model,expression:"model"}],ref:"radio",staticClass:"el-radio__original",attrs:{type:"radio","aria-hidden":"true",name:e.name,disabled:e.isDisabled,tabindex:"-1"},domProps:{value:e.label,checked:e._q(e.model,e.label)},on:{focus:function(t){e.focus=!0},blur:function(t){e.focus=!1},change:[function(t){e.model=e.label},e.handleChange]}})]),o("span",{staticClass:"el-radio__label",on:{keydown:function(e){e.stopPropagation()}}},[e._t("default"),e.$slots.default?e._e():[e._v(e._s(e.label))]],2)])};r._withStripped=!0;var n=o(4),l={name:"ElRadio",mixins:[o.n(n).a],inject:{elForm:{default:""},elFormItem:{default:""}},componentName:"ElRadio",props:{value:{},label:{},disabled:Boolean,name:String,border:Boolean,size:String},data:function(){return{focus:!1}},computed:{isGroup:function(){for(var e=this.$parent;e;){if("ElRadioGroup"===e.$options.componentName)return this._radioGroup=e,!0;e=e.$parent}return!1},model:{get:function(){return this.isGroup?this._radioGroup.value:this.value},set:function(e){this.isGroup?this.dispatch("ElRadioGroup","input",[e]):this.$emit("input",e),this.$refs.radio&&(this.$refs.radio.checked=this.model===this.label)}},_elFormItemSize:function(){return(this.elFormItem||{}).elFormItemSize},radioSize:function(){var e=this.size||this._elFormItemSize||(this.$ELEMENT||{}).size;return this.isGroup&&this._radioGroup.radioGroupSize||e},isDisabled:function(){return this.isGroup?this._radioGroup.disabled||this.disabled||(this.elForm||{}).disabled:this.disabled||(this.elForm||{}).disabled},tabIndex:function(){return this.isDisabled||this.isGroup&&this.model!==this.label?-1:0}},methods:{handleChange:function(){var e=this;this.$nextTick((function(){e.$emit("change",e.model),e.isGroup&&e.dispatch("ElRadioGroup","handleChange",e.model)}))}}},d=o(0),component=Object(d.a)(l,r,[],!1,null,null,null);component.options.__file="packages/radio/src/radio.vue";var c=component.exports;c.install=function(e){e.component(c.name,c)};t.default=c},4:function(e,t){e.exports=o(84)}})},399:function(e,t,o){},534:function(e,t,o){"use strict";var r=o(399);o.n(r).a},651:function(e,t,o){"use strict";o.r(t);o(15),o(19);var r=o(58),n=o(327),l=o.n(n),d=o(329),c=o.n(d),m=o(324),h=o.n(m),f=o(318);function v(object,e){var t=Object.keys(object);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(object);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(object,e).enumerable}))),t.push.apply(t,o)}return t}function _(e){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?v(Object(source),!0).forEach((function(t){Object(r.a)(e,t,source[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(source)):v(Object(source)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(source,t))}))}return e}var $={name:"CreateBangumi",layout:"app",components:{ElRadio:h.a,ElUpload:c.a,ElSelect:l.a},mixins:[f.a],data(){return{radio:0,tag:{id:"",avatar:"",name:"",alias:[],intro:""},rules:{alias:[{validator:(e,t,o)=>{t&&t.length||o(new Error("别名不能为空")),~t.indexOf(this.tag.name)||o(new Error("别名中必须包含名称")),t.some(e=>/,/.test(e))&&o(new Error("别名不能包含英文逗号")),t.join("").length>100&&o(new Error("别名最多100个字符")),o()},trigger:"submit"}]},submitting:!1}},methods:{avatarUploadSuccess(e,t){this.handleImageUploadSuccess(e,t),this.tag.avatar=e.data.url},fetch(){this.tag.id&&(this.$toast.loading("抓取中..."),this.$axios.$get("v1/bangumi/fetch",{params:{source_id:this.tag.id}}).then(e=>{e&&e.name&&(this.tag=_({},this.tag,{},e),this.$toast.stop())}).catch(e=>400===e.statusCode?(this.$toast.stop(),void this.$confirm("该番剧已存在，是否跳转？").then(()=>{(/qq/.test(window.navigator.userAgent.toLowerCase())?window.qq:window.wx).miniProgram.navigateTo({url:"/pages/bangumi/show/index?slug=".concat(e.message)})}).catch(()=>{})):this.$toast.error(e.message)))},submit(){this.$refs.form.validate(e=>{e&&(this.submitting=!0,this.$axios.$post("v1/bangumi/create",_({},this.tag,{alias:[this.tag.name,...this.tag.alias]})).then(e=>{this.$toast.info("创建成功"),(/qq/.test(window.navigator.userAgent.toLowerCase())?window.qq:window.wx).miniProgram.navigateTo({url:"/pages/bangumi/show/index?slug=".concat(e)})}).catch(e=>{this.$toast.error(e.message),this.submitting=!1}))})}},head:{title:"创建分区"}},w=(o(534),o(11)),component=Object(w.a)($,(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{attrs:{id:"create-bangumi"}},[o("ElForm",{ref:"form",staticClass:"edit-tag-info-form",attrs:{model:e.tag,rules:e.rules,disabled:e.submitting,"label-position":"top"}},[o("ElFormItem",{attrs:{label:"类型"}},[o("ElRadio",{attrs:{label:0},model:{value:e.radio,callback:function(t){e.radio=t},expression:"radio"}},[e._v("动漫")]),e._v(" "),o("ElRadio",{attrs:{label:1},model:{value:e.radio,callback:function(t){e.radio=t},expression:"radio"}},[e._v("游戏")]),e._v(" "),o("ElRadio",{attrs:{label:9},model:{value:e.radio,callback:function(t){e.radio=t},expression:"radio"}},[e._v("其它")])],1),e._v(" "),o("ElFormItem",{attrs:{label:"来源",required:""}},[o("ElInput",{attrs:{placeholder:"去 bgm.tv 寻找那个番剧吧！"},model:{value:e.tag.id,callback:function(t){e.$set(e.tag,"id",t)},expression:"tag.id"}})],1),e._v(" "),o("ElFormItem",[o("ElButton",{attrs:{loading:e.submitting,type:"success",round:""},on:{click:e.fetch}},[e._v("\n        抓取资源\n      ")])],1),e._v(" "),o("ElFormItem",{attrs:{label:"头像",required:""}},[o("div",{staticClass:"avatar-field"},[e.tag.avatar?o("img",{staticClass:"avatar",attrs:{src:e.$resize(e.tag.avatar,{width:100})}}):e._e(),e._v(" "),o("ElUpload",{attrs:{"show-file-list":!1,action:e.imageUploadAction,limit:e.uploadImageLimit,data:e.uploadHeaders,accept:e.imageUploadAccept,"before-upload":e.handleImageUploadBefore,"on-success":e.avatarUploadSuccess,"on-error":e.handleImageUploadError}},[o("ElButton",{attrs:{loading:!!e.uploadPending,type:"success",plain:"",round:"",size:"mini"}},[e._v("\n            "+e._s(e.uploadPending?"图片上传中...":"点击上传封面")+"\n          ")])],1)],1)]),e._v(" "),o("ElFormItem",{attrs:{label:"名称",required:""}},[o("ElInput",{model:{value:e.tag.name,callback:function(t){e.$set(e.tag,"name",t)},expression:"tag.name"}})],1),e._v(" "),o("ElFormItem",{attrs:{label:"别名",prop:"alias",required:""}},[o("p",{staticClass:"form-tip"},[e._v("\n        提示：按回车键生效\n      ")]),e._v(" "),o("ElSelect",{staticClass:"hidden-select-input",attrs:{multiple:"",filterable:"","allow-create":"","default-first-option":"",placeholder:"请输入标签别名","popper-class":"hidden-select-options"},model:{value:e.tag.alias,callback:function(t){e.$set(e.tag,"alias",t)},expression:"tag.alias"}})],1),e._v(" "),o("ElFormItem",{attrs:{label:"简介",required:""}},[o("ElInput",{attrs:{type:"textarea","show-word-limit":!0,rows:8,maxlength:"500",resize:"none",placeholder:"请输入板块介绍"},model:{value:e.tag.intro,callback:function(t){e.$set(e.tag,"intro",t)},expression:"tag.intro"}})],1),e._v(" "),o("ElFormItem",[o("ElButton",{attrs:{loading:e.submitting,type:"success",round:""},on:{click:e.submit}},[e._v("\n        保存更改\n      ")])],1)],1)],1)}),[],!1,null,null,null);t.default=component.exports}}]);