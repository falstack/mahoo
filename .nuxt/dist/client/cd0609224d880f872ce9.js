(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{315:function(e,t,n){},316:function(e,t,n){"use strict";t.a={beforeMount(){this.$channel.$when("user-not-sign",()=>{this.$toast.error("继续操作前请先登录").then(()=>{window.location.href=this.$alias.sign()})})}}},325:function(e,t,n){"use strict";var r={name:"UserAvatar",props:{user:{type:Object,required:!0},avatar:{type:String,default:""},size:{type:Number,default:40},disabled:{type:Boolean,default:!1}}},o=(n(326),n(11)),component=Object(o.a)(r,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return e.disabled?n("div",{staticClass:"user-avatar",style:{width:e.size+"px",height:e.size+"px"}},[n("VImg",{attrs:{radius:"50%",src:e.avatar||e.user.avatar,width:e.size,height:e.size,alt:e.user.nickname}})],1):n("NLink",{staticClass:"user-avatar",style:{width:e.size+"px",height:e.size+"px"},attrs:{to:e.$alias.user(e.user.slug),target:"_blank"}},[n("VImg",{attrs:{radius:"50%",src:e.avatar||e.user.avatar,width:e.size,height:e.size,alt:e.user.nickname}})],1)}),[],!1,null,null,null);t.a=component.exports},326:function(e,t,n){"use strict";var r=n(315);n.n(r).a},341:function(e,t,n){e.exports=JSON.parse('{"h1":"h1_17sSx","h2":"h2_29h8C","h3":"h3_pcROM","h4":"h4_-wXkD","h5":"h5_3RgCW","h6":"h6_1UKhu","skeleton-loading":"skeleton-loading_3wvbo","skeletonLoading":"skeleton-loading_3wvbo","skeleton":"skeleton_3yQuF"}')},342:function(e,t,n){e.exports=JSON.parse('{"image":"image_2HoYb","border":"border_fvHwL","bg":"bg_OU_Qk","skeleton-loading":"skeleton-loading_W_WF0","skeletonLoading":"skeleton-loading_W_WF0","skeleton":"skeleton_3dcSj"}')},343:function(e,t,n){e.exports=JSON.parse('{"paragraph":"paragraph_1OWG2","skeleton-loading":"skeleton-loading_3Hgsp","skeletonLoading":"skeleton-loading_3Hgsp","skeleton":"skeleton_2H5RA"}')},344:function(e,t,n){e.exports=JSON.parse('{"list":"list_rxwoA","skeleton-loading":"skeleton-loading_hADmg","skeletonLoading":"skeleton-loading_hADmg","skeleton":"skeleton_3a9b2"}')},345:function(e,t,n){e.exports=JSON.parse('{"delimiter":"delimiter_3ksS5","skeleton-loading":"skeleton-loading_1lzJ0","skeletonLoading":"skeleton-loading_1lzJ0","skeleton":"skeleton_jIhh3"}')},346:function(e,t,n){e.exports=JSON.parse('{"checklist":"checklist_35Trq","skeleton-loading":"skeleton-loading_2NnRn","skeletonLoading":"skeleton-loading_2NnRn","skeleton":"skeleton_RKAJg"}')},347:function(e,t,n){e.exports=JSON.parse('{"link":"link_1cdqF","content":"content_31mUQ","logo":"logo_3t3p1","skeleton-loading":"skeleton-loading_Q1SbS","skeletonLoading":"skeleton-loading_Q1SbS","skeleton":"skeleton_13H0b"}')},348:function(e,t,n){e.exports=JSON.parse('{"video":"video_1Ktgc","wrap":"wrap_3iFmj","skeleton-loading":"skeleton-loading_DCN-u","skeletonLoading":"skeleton-loading_DCN-u","skeleton":"skeleton_1YNsK"}')},349:function(e,t,n){e.exports=JSON.parse('{"music":"music_1aU_y","skeleton-loading":"skeleton-loading_3yST_","skeletonLoading":"skeleton-loading_3yST_","skeleton":"skeleton_3Zagh"}')},350:function(e,t,n){e.exports=JSON.parse('{"baidu":"baidu_3yD19","logo":"logo_3fZIb","content":"content_2vYlq","skeleton-loading":"skeleton-loading_2_Vpm","skeletonLoading":"skeleton-loading_2_Vpm","skeleton":"skeleton_Yoxzs"}')},351:function(e,t,n){e.exports=JSON.parse('{"vote":"vote_1AMl_","selected":"selected_1h5XP","count":"count_3bLzQ","active":"active_2YTSY","skeleton-loading":"skeleton-loading_2BuFl","skeletonLoading":"skeleton-loading_2BuFl","skeleton":"skeleton_3B0sO"}')},362:function(e,t,n){"use strict";n(52);t.a={beforeMount(){var e=()=>{this.$store.getters.isMine(this.$route.params.slug)||this.$router.replace({name:this.$route.name,params:{slug:this.$store.state.user.slug}})};if(this.$store.state.isAuth)e();else var t=this.$watch("$store.state.isAuth",n=>{n&&(e(),t())})}}},368:function(e,t,n){"use strict";var r={name:"JsonHeader",props:{item:{type:Object,required:!0}},render(e){var t=this.item.data.level;return e("h"+this.item.data.level,{class:this.$style["h".concat(t)],domProps:{innerHTML:this.item.data.text}})}},o=n(415),l=n(11);var header=Object(l.a)(r,void 0,void 0,!1,(function(e){this.$style=o.default.locals||o.default}),null,null).exports,c={name:"JsonImage",props:{item:{type:Object,required:!0}}},d=n(416);var h=Object(l.a)(c,(function(){var e,t,n=this,r=n.$createElement,o=n._self._c||r;return o("div",{class:n.$style.image},[o("div",{class:[(e={},e[n.$style.border]=n.item.data.withBorder,e),(t={},t[n.$style.bg]=n.item.data.withBackground,t)]},[o("div",[o("VImg",{attrs:{src:n.item.data.file.url,stretched:n.item.data.stretched,width:n.item.data.file.width,height:n.item.data.file.height}})],1)]),n._v(" "),n.item.data.caption?o("p",{domProps:{textContent:n._s(n.item.data.caption)}}):n._e()])}),[],!1,(function(e){this.$style=d.default.locals||d.default}),null,null).exports,m={name:"JsonParagraph",props:{item:{type:Object,required:!0}}},f=n(417);var v=Object(l.a)(m,(function(){var e=this.$createElement;return(this._self._c||e)("p",{class:this.$style.paragraph,domProps:{innerHTML:this._s(this.item.data.text.replace(/\n/g,"<br>"))}})}),[],!1,(function(e){this.$style=f.default.locals||f.default}),null,null).exports,_={name:"JsonList",props:{item:{type:Object,required:!0}}},y=n(418);var k=Object(l.a)(_,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{class:e.$style.list},["ordered"===e.item.data.style?n("ol",e._l(e.item.data.items,(function(li,t){return n("li",{key:t,domProps:{innerHTML:e._s(li)}})})),0):n("ul",e._l(e.item.data.items,(function(li,t){return n("li",{key:t,domProps:{innerHTML:e._s(li)}})})),0)])}),[],!1,(function(e){this.$style=y.default.locals||y.default}),null,null).exports,$={name:"JsonDelimiter",props:{item:{type:Object,required:!0}}},x=n(419);var C=Object(l.a)($,(function(){var e=this.$createElement;return(this._self._c||e)("div",{class:this.$style.delimiter})}),[],!1,(function(e){this.$style=x.default.locals||x.default}),null,null).exports,w={name:"JsonChecklist",props:{item:{type:Object,required:!0}}},S=n(420);var M=Object(l.a)(w,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ul",{class:e.$style.checklist},e._l(e.item.data.items,(function(option,t){return n("li",{key:t},[option.checked?n("i"):n("em"),e._v(" "),n("div",{domProps:{innerHTML:e._s(option.text)}})])})),0)}),[],!1,(function(e){this.$style=S.default.locals||S.default}),null,null).exports,O={name:"JsonLink",props:{item:{type:Object,required:!0}}},L=n(421);var E=Object(l.a)(O,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{class:e.$style.link},[n("a",{attrs:{target:"_blank",href:e.item.data.link}},[e.item.data.meta.image&&e.item.data.meta.image.url?n("img",{class:e.$style.logo,attrs:{src:e.item.data.meta.image.url,width:"65",height:"65"}}):e._e(),e._v(" "),n("div",{class:e.$style.content},[n("h3",{domProps:{textContent:e._s(e.item.data.meta.title)}}),e._v(" "),n("p",{domProps:{textContent:e._s(e.item.data.meta.description)}}),e._v(" "),n("span",{domProps:{textContent:e._s(e.item.data.link.replace(/https?:\/\//,""))}})])])])}),[],!1,(function(e){this.$style=L.default.locals||L.default}),null,null).exports,T={name:"JsonVideo",props:{item:{type:Object,required:!0}}},j=n(422);var video=Object(l.a)(T,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{class:e.$style.video},[n("div",{class:e.$style.wrap},[n("iframe",{attrs:{src:e.item.data.embed,scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowtransparency:"true",allowfullscreen:"true"}})]),e._v(" "),e.item.data.caption?n("p",{domProps:{textContent:e._s(e.item.data.caption)}}):e._e()])}),[],!1,(function(e){this.$style=j.default.locals||j.default}),null,null).exports,H={name:"JsonMusic",props:{item:{type:Object,required:!0}}},J=n(423);var R=Object(l.a)(H,(function(){var e=this.$createElement,t=this._self._c||e;return t("div",{class:this.$style.music},[t("iframe",{attrs:{src:this.item.data.embed,scrolling:"no",border:"0",frameborder:"no",framespacing:"0",allowtransparency:"true",allowfullscreen:"true",width:"330",height:"86"}}),this._v(" "),this.item.data.caption?t("p",{domProps:{textContent:this._s(this.item.data.caption)}}):this._e()])}),[],!1,(function(e){this.$style=J.default.locals||J.default}),null,null).exports,A={name:"JsonBaidu",props:{item:{type:Object,required:!0},reward:{type:Boolean,required:!0}}},N=n(424);var D=Object(l.a)(A,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{class:e.$style.baidu},[n("a",{attrs:{href:e.item.data.url,target:"_blank"}},[n("i",{staticClass:"iconfont ic-baidu-cloud",class:e.$style.logo}),e._v(" "),n("div",{class:e.$style.content},[0===e.item.data.visit_type||e.reward?[e._v(" 密码："+e._s(e.item.data.password)+" ")]:[e._v("\n        密码投食后可见\n      ")]],2)])])}),[],!1,(function(e){this.$style=N.default.locals||N.default}),null,null).exports,P=(n(15),n(9),n(314),n(19),{name:"JsonVote",props:{item:{type:Object,required:!0},vote:{type:Array,required:!0},slug:{type:String,required:!0}},data:()=>({selected:[],submitting:!1,voted:!1,stat:[],maxCount:0}),watch:{vote(e){this.selected=e.map(e=>e),e.length&&(this.voted=!0,this.getVoteStat())}},methods:{getVoteStat(){this.$axios.$get("v1/pin/vote_stat",{params:{slug:this.slug}}).then(data=>{this.stat=data,this.maxCount=Math.max(...Object.values(this.stat))}).catch(()=>{})},handleSelect(option){var{selected:e,voted:t}=this;if(!t){var n=e.indexOf(option.id);if(~n)e.splice(n,1);else{var r=this.item.data.max_select;r<=e.length?1===r&&e.splice(n,1,option.id):e.push(option.id)}}},checkSelected(option){return~this.selected.indexOf(option.id)},submit(){this.submitting||this.voted||(this.selected.length?this.item.data.expired_at&&1e3*this.item.data.expired_at<Date.now()?this.$toast.info("投票已截止"):(this.submitting=!0,this.$axios.$post("v1/social/vote",{pin_slug:this.slug,answer_hash:this.selected}).then(()=>{this.$toast.success("投票成功"),this.voted=!0,this.getVoteStat()}).catch(e=>{this.$toast.error(e.message)}).finally(()=>{this.submitting=!1})):this.$toast.info("至少选择一项"))},computeItemStyle(option,e){var t=this.stat[option.id]||0;return{width:t?"".concat(75*t/this.maxCount,"%"):"0%",backgroundColor:this.getRandomColor(e)}},getRandomColor:e=>["rgba(255,170,170,.5)","rgba(255,148,39,.5)","rgba(252,196,25,.5)","rgba(32,201,151,.5)","rgba(18,183,245,.5)","rgba(173,181,189,.5)"][e%6]}}),U=n(425);var W=Object(l.a)(P,(function(){var e,t=this,n=t.$createElement,r=t._self._c||n;return r("div",{class:t.$style.vote},[r("div",[r("header",[t._v("投票（"+t._s(1===t.item.data.max_select?"单选":"最多选"+t.item.data.max_select+"个")+"）")]),t._v(" "),r("ul",t._l(t.item.data.items,(function(option,e){var n;return r("li",{key:option.id,staticClass:"oneline",class:(n={},n[t.$style.selected]=t.checkSelected(option),n),on:{click:function(e){return t.handleSelect(option)}}},[r("span",{class:t.$style.count,style:t.computeItemStyle(option,e),domProps:{innerHTML:t._s(t.stat[option.id]?t.stat[option.id]+"票&nbsp;&nbsp;":"")}}),t._v(" "),r("span",{domProps:{innerHTML:t._s(e+1+". "+option.text)}}),t._v(" "),r("i")])})),0),t._v(" "),r("footer",[r("span",[t._v("截止时间："+t._s(t.item.data.expired_at?t.$utils.timeAgo(t.item.data.expired_at):"无限期"))]),t._v(" "),r("button",{class:(e={},e[t.$style.active]=t.selected.length&&!t.voted,e),on:{click:t.submit}},[t._v("\n        "+t._s(t.submitting?"提交中":t.voted?"已投过票":"确认")+"\n      ")])])])])}),[],!1,(function(e){this.$style=U.default.locals||U.default}),null,null).exports;n(51),n(54),n(188);class B{constructor(){var{minLength:e,shareLink:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.config={org:"calibur",appendStr:"文章著作权归作者所有，任何形式的转载都请联系作者获得授权并注明出处。",minLength:e||140,shareLink:t||window.location.href.split("?")[0]},this.prefix={org:"来源",link:"链接",author:"作者"}}bind(e){var{minLength:t,authorNickname:n,shareLink:r,appendStr:o}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e.addEventListener("copy",e=>{var l=t||this.config.minLength,c=r||this.config.shareLink,d=o||this.config.appendStr,h=window.getSelection().getRangeAt(0),m=this.getHTMLParser("");m&&m.appendChild(h.cloneContents());var f=h.toString().trim(),v=m?m.innerHTML:this.getRangeHtml(h);if(document.createElement("div").innerHTML=v,f.length>=l){var _=this.getCopyHtml(v,c,n,d),y=this.getCopyText(f,c,n,d);void 0===e.clipboardData&&this.hack(_,h);try{e.clipboardData.setData("text/plain",y),e.clipboardData.setData("text/html",_),e.preventDefault()}catch(e){this.hack(_,h)}}})}abort(e){e.addEventListener("copy",e=>(e.stopPropagation(),e.preventDefault(),e.cancelBubble=!1,!1))}hack(text,e){var t=document.createElement("div");t.innerHTML=text,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),window.getSelection().selectAllChildren(t),setTimeout(()=>{try{window.getSelection().removeAllRanges(),window.getSelection().addRange(e)}catch(e){}document.body.removeChild(t)},0)}getCopyHtml(html,e,t,n){var r=this.getExtraCopyright(e,t,n).join("<br>");return"<div><div>".concat(html,"</div>").concat(r,"</div>")}getCopyText(text,e,t,n){return text+this.getExtraCopyright(e,t,n).join("\n")}getExtraCopyright(e,t,n){return t?["","","".concat(this.prefix.author,"：").concat(t),"".concat(this.prefix.link,"：").concat(e),"".concat(this.prefix.org,"：").concat(this.config.org),n]:["","","".concat(this.prefix.link,"：").concat(e),"".concat(this.prefix.org,"：").concat(this.config.org),n]}getRangeHtml(text){var div=document.createElement("div");return div.appendChild(text.cloneContents()),div.outerHTML}getHTMLParser(e){try{return(new window.DOMParser).parseFromString(e,"text/html").body}catch(n){var t=document.implementation.createHTMLDocument("");return t.body.innerHTML=e,t.body}}}var I={name:"JsonContent",components:{"v-header":header,"v-image":h,"v-paragraph":v,"v-list":k,"v-delimiter":C,"v-checklist":M,"v-link":E,"v-video":video,"v-music":R,"v-baidu":D,"v-vote":W},props:{content:{required:!0,type:Array},reward:{type:Boolean,default:!1},vote:{type:Array,default:()=>[]},slug:{type:String,default:""}},mounted(){(new B).bind(this.$el)}},z=Object(l.a)(I,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("section",{staticClass:"json-content"},e._l(e.content,(function(t,r){return n("v-"+t.type,{key:r,tag:"component",attrs:{item:t,reward:e.reward,vote:e.vote,slug:e.slug}})})),1)}),[],!1,null,null,null);t.a=z.exports},415:function(e,t,n){"use strict";var r=n(341),o=n.n(r);t.default=o.a},416:function(e,t,n){"use strict";var r=n(342),o=n.n(r);t.default=o.a},417:function(e,t,n){"use strict";var r=n(343),o=n.n(r);t.default=o.a},418:function(e,t,n){"use strict";var r=n(344),o=n.n(r);t.default=o.a},419:function(e,t,n){"use strict";var r=n(345),o=n.n(r);t.default=o.a},420:function(e,t,n){"use strict";var r=n(346),o=n.n(r);t.default=o.a},421:function(e,t,n){"use strict";var r=n(347),o=n.n(r);t.default=o.a},422:function(e,t,n){"use strict";var r=n(348),o=n.n(r);t.default=o.a},423:function(e,t,n){"use strict";var r=n(349),o=n.n(r);t.default=o.a},424:function(e,t,n){"use strict";var r=n(350),o=n.n(r);t.default=o.a},425:function(e,t,n){"use strict";var r=n(351),o=n.n(r);t.default=o.a},427:function(e,t,n){e.exports=n.p+"img/e82d3e7.png"},451:function(e,t,n){},452:function(e,t,n){},453:function(e,t,n){},454:function(e,t,n){},455:function(e,t,n){},456:function(e,t,n){},579:function(e,t,n){"use strict";var r=n(451);n.n(r).a},584:function(e,t,n){"use strict";var r=n(452);n.n(r).a},585:function(e,t,n){"use strict";var r=n(453);n.n(r).a},588:function(e,t,n){"use strict";var r=n(454);n.n(r).a},589:function(e,t,n){"use strict";var r=n(455);n.n(r).a},590:function(e,t,n){"use strict";var r=n(456);n.n(r).a},629:function(e,t,n){"use strict";n.r(t);var r=n(577),o=n.n(r),l=n(2),c=n(159),d={name:"MessageMenu",props:{slug:{type:String,required:!0}},data:()=>({menuWatcher:null,timeWatcher:null,friends:[]}),computed:{menu(){return this.$store.state.messageMenu.list}},mounted(){this.menuWatcher=this.$watch("$store.state.mailbox.unread_message_total",(e,t)=>{e>t&&!this.$store.state.socket.isConnected&&this.$store.dispatch("getMessageMenu")}),this.timeWatcher=this.$watch("$store.state.messageMenu.time",()=>{this.$store.dispatch("updateMessageMenu")}),this.$store.dispatch("updateMessageMenu"),this.menu.length&&this.$store.state.socket.isConnected||this.initChatRoom()},beforeDestroy(){this.menuWatcher&&this.menuWatcher(),this.timeWatcher&&this.timeWatcher()},methods:{initChatRoom(){var e=this;return Object(l.a)((function*(){var t=o.a.service({target:e.$el});yield e.getUserFriends(),yield e.$store.dispatch("getMessageMenu"),t.close()}))()},getUserFriends(){var e=this;return Object(l.a)((function*(){var t=()=>{Object(c.getUserRelation)({$axios:e.$axios,slug:e.slug,relation:"friend"}).then(data=>{data.result.forEach(t=>e.$cache.setUserSessionStore(t)),e.friends=data.result,sessionStorage.setItem("user-friends-list",JSON.stringify(data.result))})};try{var n=sessionStorage.getItem("user-friends-list");if(!n)return void(yield t());var r=JSON.parse(n);r.forEach(t=>e.$cache.setUserSessionStore(t)),e.friends=r}catch(e){yield t()}}))()},deleteChannel(e){this.$axios.$post("v1/message/delete_channel",{channel:e.channel}).then(()=>{this.$store.commit("DELETE_MESSAGE_MENU",e.channel)}).catch(()=>{})},emitClick(e){this.$emit("open",e)}}},h=(n(579),n(11)),m=Object(h.a)(d,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ul",{staticClass:"message-menu"},e._l(e.menu,(function(t){return n("li",{key:t.channel},[n("div",{staticClass:"room-item clearfix",on:{click:function(n){return e.emitClick(t)}}},[t.user.avatar?n("img",{staticClass:"avatar",attrs:{src:e.$resize(t.user.avatar,{width:42}),alt:t.user.nickname}}):e._e(),e._v(" "),n("div",{staticClass:"content"},[n("p",{staticClass:"nickname oneline",domProps:{innerHTML:e._s(t.user.nickname)}}),e._v(" "),n("div",{staticClass:"footer"},[t.count?n("div",{staticClass:"read-badge",domProps:{textContent:e._s(t.count)}}):e._e()])])]),e._v(" "),n("div",{staticClass:"close",on:{click:function(n){return e.deleteChannel(t)}}},[e._v("\n      ×\n    ")])])})),0)}),[],!1,null,null,null).exports,f=(n(580),n(51),n(188),n(582)),v=n.n(f),_=(n(583),{name:"ChatAvatar",components:{UserAvatar:n(325).a},props:{item:{type:Object,required:!0}},computed:{isMine(){return this.$store.state.user.slug===this.item.slug}}}),y=(n(584),Object(h.a)(_,(function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"chat-avatar",class:[this.isMine?"chat-avatar-mine":"chat-avatar-other"]},[t("UserAvatar",{attrs:{user:this.item,size:36}})],1)}),[],!1,null,null,null).exports),k={name:"ChatMessage",components:{JsonContent:n(368).a},props:{item:{type:Object,required:!0}}},$=(n(585),Object(h.a)(k,(function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"chat-message"},[t("JsonContent",{attrs:{content:this.item.content}})],1)}),[],!1,null,null,null).exports),x=(n(9),n(586)),C=n(587),w={name:"VScroll",props:{probeType:{type:Number,default:1},click:{type:Boolean,default:!0},data:{type:Array,default:null},scrollX:{type:Boolean,default:!1}},watch:{data(){this.refresh()}},mounted(){setTimeout(()=>{this._initScroll()},20)},beforeDestroy(){this.scroll&&this.scroll.destroy()},methods:{_initScroll(){this.$refs.wrapper&&(x.a.use(C.a),this.scroll=new x.a(this.$refs.wrapper,{probeType:this.probeType,click:this.click,fade:!0,scrollX:this.scrollX,scrollY:!this.scrollX,mouseWheel:{invert:!1,speed:30,easeTime:300}}),this.scroll.on("scrollEnd",()=>{this.scroll.y>-50&&this.$emit("top"),this.scroll.y<=this.scroll.maxScrollY+50&&this.$emit("bottom")}))},enable(){this.scroll&&this.scroll.enable()},disable(){this.scroll&&this.scroll.disable()},refresh(){return new Promise(e=>{this.$nextTick(()=>{setTimeout(()=>{this.scroll&&this.scroll.refresh(),this.$nextTick(()=>{e()})},20)})})},scrollTo(){setTimeout(()=>{this.scroll&&this.scroll.scrollTo.apply(this.scroll,arguments)},0)},scrollToElement(){setTimeout(()=>{this.scroll&&this.scroll.scrollToElement.apply(this.scroll,arguments)},0)}}},S=(n(588),{name:"MessageRoom",components:{Scroll:Object(h.a)(w,(function(){var e=this.$createElement;return(this._self._c||e)("div",{ref:"wrapper",staticClass:"scroll-warp"},[this._t("default")],2)}),[],!1,null,null,null).exports,ChatRoom:v.a},props:{mailto:{type:String,required:!0},name:{type:String,required:!0},slug:{type:String,required:!0}},data:()=>({message:"",target:null,chatsHeight:0,stopWatcher:null,noMore:!1}),computed:{query(){return{channel:this.mailto,$axios:this.$axios}},avatarComp:()=>y,messageComps:()=>({message:$}),computeHelperTxt:()=>"undefined"==typeof window?"":/windows/.test(window.navigator.userAgent.toLocaleLowerCase())?"按下Ctrl+Enter换行":"按下Cmd+Enter换行"},watch:{$route(){this.initRoom()}},beforeMount(){this.$store.state.messageRoom[this.mailto]||this.$store.commit("INIT_MESSAGE_ROOM",this.mailto)},mounted(){this.initRoom()},methods:{initRoom(){var e=this;this.$nextTick(Object(l.a)((function*(){e.$refs.room&&e.$refs.room.clearMessage(),e.$refs.loader&&e.$refs.loader.forceCallback(),yield e.$refs.loader.initData({is_up:1}),yield e.$refs.loader.loadMore({force:!0}),e.clearUnreadCount(),e.watchMessageLoop()})))},clearUnreadCount(){var menu=this.$store.state.messageMenu.list.filter(e=>e.channel===this.mailto)[0];!menu||menu.count<=0||(this.$axios.$post("v1/message/clear_channel",{channel:this.mailto}),this.$store.commit("CLEAR_NOTIFICATION",{channel:this.mailto,count:menu.count}))},watchMessageLoop(){this.stopWatcher&&this.stopWatcher();var e=this,t=e.mailto;this.stopWatcher=this.$watch((function(){return e.$store.state.messageRoom[e.mailto].time}),(function(){if(t===e.mailto){var n=e.$store.state.messageRoom[e.mailto].data;e.$store.state.socket.isConnected&&n?e.appendMessage(n):e.$refs.loader.loadMore({force:!0}),e.screenScroll(),e.clearUnreadCount()}else this.stopWatcher()}))},handleScrollUp(){this.noMore||this.$refs.loader.loadBefore({force:!0})},handleMessageLoad(e){var{data:data,params:t}=e;0!==t.is_up||data.result.length||(this.noMore=!0),this.$nextTick(()=>{1===t.is_up?(data.result.map(e=>e).reverse().map(e=>{this.appendMessage(e,!1)}),this.screenScroll(!1)):(data.result.map(e=>{this.appendMessage(e)}),this.screenScroll())})},screenScroll(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.$refs.scroll&&this.$refs.scroll.refresh().then(()=>{var t=this.$refs.room.$el.clientHeight,n=this.$refs.wrap.clientHeight;t<n||(this.lastChatsHeight&&!e?this.$refs.scroll.scrollTo(0,this.lastChatsHeight-t):this.$refs.scroll.scrollTo(0,n-t),this.lastChatsHeight=t)})},appendMessage(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.$refs.room.addMessage({id:e.id,type:"message",float:e.user.slug===this.slug?"right":"left",color:2===e.user.sex?{bg:"#ff6881",text:"#fff"}:{bg:"#12b7f5",text:"#fff"},data:e},t)},handleAddBubble(){if(this.message.trim()){var e=[{type:"paragraph",data:{text:this.message.trim()}}],t=Math.random().toString(10).substring(3,6);this.appendMessage({id:t,user:this.$store.state.user,content:e,created_at:Date.now()}),this.screenScroll(),this.message="",this.$axios.$post("v1/message/send",{channel:this.mailto,content:e}).then(e=>{this.$refs.room.updateMessage(t,{id:e.id}),this.$refs.loader.append(e)}).catch(()=>{this.$refs.room.updateMessage(t,{status:"error"})})}},handleNewLine(){this.message&&(this.message+="\n")}}}),M=(n(589),Object(h.a)(S,(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"room"},[n("div",{staticClass:"room-header"},[e._v("\n    "+e._s(e.name)+"\n  ")]),e._v(" "),n("FlowLoader",{ref:"loader",staticClass:"room-body",attrs:{func:"getUserMessage",type:"sinceId",query:e.query,callback:e.handleMessageLoad,"callback-once":!1,"cache-timeout":86400,auto:0},scopedSlots:e._u([{key:"default",fn:function(t){var r=t.flow;return n("div",{ref:"wrap",staticClass:"room-chats"},[n("Scroll",{ref:"scroll",attrs:{data:r},on:{top:e.handleScrollUp}},[n("ChatRoom",{ref:"room",attrs:{"avatar-component":e.avatarComp,"message-components":e.messageComps}})],1)],1)}}])}),e._v(" "),n("div",{staticClass:"room-footer"},[n("textarea",{directives:[{name:"model",rawName:"v-model",value:e.message,expression:"message"}],attrs:{maxlength:"500",placeholder:"say it..."},domProps:{value:e.message},on:{keyup:[function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:t.ctrlKey||t.shiftKey||t.altKey||t.metaKey?null:(t.preventDefault(),e.handleAddBubble(t))},function(t){return t.ctrlKey?t.shiftKey||t.altKey||t.metaKey?null:(t.preventDefault(),e.handleAddBubble(t)):null}],keydown:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:t.metaKey?(t.preventDefault(),e.handleNewLine(t)):null},input:function(t){t.target.composing||(e.message=t.target.value)}}}),e._v(" "),n("div",{staticClass:"helper"},[n("span",{domProps:{textContent:e._s(e.computeHelperTxt)}}),e._v(" "),n("button",{on:{click:e.handleAddBubble}},[e._v("\n        发送\n      ")])])])],1)}),[],!1,null,null,null).exports),O=n(362),L={name:"UserMessage",components:{MessageMenu:m,MessageRoom:M},mixins:[n(316).a,O.a],props:{slug:{type:String,required:!0}},computed:{mailto(){return this.$route.query.mailto},name(){return this.$route.query.name}},methods:{handleOpen(e){this.$router.push(this.$alias.user(this.slug,"message/?mailto=".concat(e.channel,"&name=").concat(e.user.nickname)))}}},E=(n(590),Object(h.a)(L,(function(){var e=this,t=e.$createElement,r=e._self._c||t;return r("div",{attrs:{id:"user-message"}},[r("ElRow",{staticClass:"column-wrap"},[r("ElCol",{attrs:{span:6}},[r("MessageMenu",{attrs:{slug:e.slug},on:{open:e.handleOpen}}),e._v("\n       \n    ")],1),e._v(" "),r("ElCol",{attrs:{span:18}},[r("div",{staticClass:"room-adjust"},[e.mailto?r("MessageRoom",{attrs:{mailto:e.mailto,name:e.name,slug:e.slug}}):r("div",{staticClass:"need-pick"},[r("img",{attrs:{src:n(427)}}),e._v(" "),r("p",[e._v("未选择聊天")])])],1)])],1)],1)}),[],!1,null,null,null));t.default=E.exports}}]);