(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{248:function(t,e,n){"use strict";n(25);var o,r=n(2),c=n(73);e.a={beforeMount:(o=Object(r.a)(regeneratorRuntime.mark((function t(){var e,n,o=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.$store.state.logging){t.next=4;break}e=this.$watch("$store.state.logging",(function(){o.$store.state.isAuth?(o.$channel.$fire("user-signed"),e()):(o.$cookie.remove("JWT-TOKEN"),o.$channel.$fire("user-not-sign"))})),t.next=10;break;case 4:return n=Object(c.a)(),this.$store.commit("SET_USER_TOKEN",n),t.next=8,this.$store.dispatch("initAuth");case 8:t.sent?(this.$channel.$fire("user-signed"),this.$store.dispatch("getUserRoles")):(this.$cookie.remove("JWT-TOKEN"),this.$channel.$fire("user-not-sign"));case 10:case"end":return t.stop()}}),t,this)}))),function(){return o.apply(this,arguments)})}},258:function(t,e,n){},259:function(t,e,n){},260:function(t,e,n){},261:function(t,e,n){},283:function(t,e,n){"use strict";var o=n(258);n.n(o).a},284:function(t,e,n){"use strict";var o=n(259);n.n(o).a},285:function(t,e,n){"use strict";var o=n(260);n.n(o).a},286:function(t,e,n){"use strict";var o=n(261);n.n(o).a},327:function(t,e,n){"use strict";n.r(e);n(281),n(245);var o,r,c,h=n(282),l=n.n(h),m=(n(254),n(255)),d=n.n(m),f=(n(246),n(247)),v=n.n(f),w=(n(256),n(257)),$=n.n(w),k=n(46),_={name:"SignInForm",components:{VForm:$.a,VButton:v.a,VField:d.a,VRadio:l.a},data:function(){return{form:{access:"",secret:"",remember:!0},rule:{access:{validator:function(t,e,n){return e?11!==e.length?n(new Error("请填写11位手机号")):void n():n(new Error("请填写手机号"))}},secret:{validator:function(t,e,n){return""===e?n(new Error("请填写登录密码")):e.length<6?n(new Error("密码不能小于6位")):e.length>16?n(new Error("密码不能大于16位")):void n()}}},loading:!1,showOAuth:!0}},methods:{authQQ:function(){window.location.href="https://api.calibur.tv/callback/oauth2/qq?from=sign"},authWechat:function(){window.location.href="https://api.calibur.tv/callback/oauth2/wechat?from=sign"},redirect:function(){return this.$route.query.redirect?this.$route.query.redirect:encodeURIComponent(window.location.href)},login:function(){var t=this;this.loading||(this.loading=!0,Object(k.d)(this,{access:this.form.access,secret:this.form.secret,remember:this.form.remember}).then((function(e){t.$cookie.set("JWT-TOKEN",e,{expires:t.form.remember?365:1}),t.$route.query.redirect?window.location=decodeURIComponent(t.$route.query.redirect):window.location.reload()})).catch((function(e){t.$toast.error(e.message),t.loading=!1})))},showReset:function(){this.$emit("to-reset")},showRegister:function(){this.$emit("to-register")}}},C=(n(283),n(53)),y=Object(C.a)(_,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"sign-in-form"},[n("VForm",{attrs:{loading:t.loading,form:t.form,rule:t.rule,error:!1},on:{submit:t.login}},[n("VField",{attrs:{type:"text",placeholder:"手机（填写常用手机号，用于登录）"},model:{value:t.form.access,callback:function(e){t.$set(t.form,"access","string"==typeof e?e.trim():e)},expression:"form.access"}}),t._v(" "),n("VField",{attrs:{type:"password","show-password":"",placeholder:"密码（6-16个字符组成，区分大小写）"},nativeOn:{keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.submitForm(e)}},model:{value:t.form.secret,callback:function(e){t.$set(t.form,"secret","string"==typeof e?e.trim():e)},expression:"form.secret"}}),t._v(" "),n("div",{staticClass:"opt-container"},[n("VRadio",{attrs:{size:"small",label:"记住我"},model:{value:t.form.remember,callback:function(e){t.$set(t.form,"remember",e)},expression:"form.remember"}}),t._v(" "),t.showOAuth?n("ul",{staticClass:"provider"},[n("li",{on:{click:t.authQQ}},[n("i",{staticClass:"iconfont ic-qq"})]),t._v(" "),n("li",{on:{click:t.authWechat}},[n("i",{staticClass:"iconfont ic-v-chat"})])]):n("button",{attrs:{type:"button"},on:{click:function(e){t.showOAuth=!0}}},[t._v("\n        社交账号登录\n      ")])],1),t._v(" "),n("VButton",{attrs:{slot:"submit",loading:t.loading,size:"large",block:"",round:""},slot:"submit"},[t._v("\n      登录\n    ")])],1),t._v(" "),n("div",{staticClass:"others"},[n("a",{on:{click:t.showReset}},[t._v("忘记密码?>")]),t._v(" "),n("a",{on:{click:t.showRegister}},[t._v("点击注册»")])])],1)}),[],!1,null,null,null).exports,R=(n(26),n(40),n(263),n(57),n(25),n(2)),x={name:"SignUpForm",components:{VForm:$.a,VButton:v.a,VField:d.a},props:{inviteCode:{type:[String,Number],default:""}},data:function(){return{form:{access:"",secret:"",authCode:"",inviteCode:this.inviteCode},rule:{access:{validator:function(t,e,n){return e?11!==e.length?n(new Error("请填写11位手机号")):/^(0|86|17951)?(1)[0-9]{10}$/.test(e)?void n():n(new Error("错误的手机号格式")):n(new Error("请填写手机号"))}},secret:{validator:function(t,e,n){return""===e?n(new Error("请填写登录密码")):e.length<6?n(new Error("密码不能小于6位")):e.length>16?n(new Error("密码不能大于16位")):void n()}}},step:0,timeout:0}},computed:{submitBtnText:function(){return 0===this.step?"注册":1===this.step?"提交中...":2===this.step?"短信已发送":3===this.step?"注册中...":"注册"},submitBtnLoading:function(){return 1===this.step||3===this.step},submitBtnDisabled:function(){return 0!==this.timeout&&0===this.step||3===this.step},query:function(){return this.$route.query},paramsIsOK:function(){return!!(this.query.uid&&/^\d+$/.test(this.query.uid)&&this.query.time&&/^\d+$/.test(this.query.time)&&Date.now()<=1e3*this.query.time&&this.query.key===this.$md5("".concat(this.query.uid,"-the-world-").concat(this.query.time)))}},methods:{addInviteForLink:function(t){var e=t;return this.paramsIsOK?e="".concat(e,"&invite=").concat(this.query.uid):"about-invite-id"===this.$route.name&&(e="".concat(e,"&invite=").concat(this.$route.params.id)),e},qqRegisterLink:function(){window.location.href="".concat(this.addInviteForLink("https://api.calibur.tv/callback/oauth2/qq?from=sign"),"}")},wechatRegisterLink:function(){window.location.href="".concat(this.addInviteForLink("https://api.calibur.tv/callback/oauth2/wechat?from=sign"),"}")},redirect:function(){return this.$route.query.redirect?this.$route.query.redirect:encodeURIComponent(window.location.href)},submitForm:function(){0===this.step&&this.getRegisterAuthCode(),2===this.step&&this.openConfirmModal()},getRegisterAuthCode:(o=Object(R.a)(regeneratorRuntime.mark((function t(){var e,n=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.step=1,t.prev=1,t.next=4,Object(k.h)(this,{type:"sign_up",phone_number:this.form.access});case 4:this.step=2,this.openConfirmModal(),t.next=12;break;case 8:t.prev=8,t.t0=t.catch(1),this.$toast.error(t.t0.message),this.step=0;case 12:return t.prev=12,this.timeout=60,e=setInterval((function(){--n.timeout||(n.step=0,clearInterval(e))}),1e3),t.finish(12);case 16:case"end":return t.stop()}}),t,this,[[1,8,12,16]])}))),function(){return o.apply(this,arguments)}),openConfirmModal:function(){var t=this;this.$prompt("请输入收到的验证码","短信已发送",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^\d{6}$/,inputErrorMessage:"验证码格式不正确"}).then((function(e){var n=e.value;t.form.authCode=n,t.step=3,t.signUp()})).catch((function(){}))},signUp:function(){var t=this;Object(k.f)(this,{access:this.form.access,secret:this.form.secret,authCode:this.form.authCode,inviteCode:this.form.inviteCode}).then((function(e){t.$cookie.set("JWT-TOKEN",e),t.$toast.success("注册成功！").then((function(){t.$route.query.redirect?window.location=decodeURIComponent(t.$route.query.redirect):window.location.reload()}))})).catch((function(e){t.step=0,t.$toast.error(e.message)}))},showLogin:function(){this.$emit("to-login")}}},S=(n(284),Object(C.a)(x,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"sign-up-form"},[n("VForm",{attrs:{loading:t.submitBtnLoading,form:t.form,rule:t.rule,error:!1},on:{submit:t.submitForm}},[n("VField",{attrs:{type:"text",placeholder:"手机（填写常用手机号，用于登录）","auto-complete":"off"},model:{value:t.form.access,callback:function(e){t.$set(t.form,"access","string"==typeof e?e.trim():e)},expression:"form.access"}}),t._v(" "),n("VField",{attrs:{type:"password","show-password":"",placeholder:"密码（6-16个字符组成，区分大小写）","auto-complete":"off"},model:{value:t.form.secret,callback:function(e){t.$set(t.form,"secret","string"==typeof e?e.trim():e)},expression:"form.secret"}}),t._v(" "),t.inviteCode?t._e():n("VField",{attrs:{placeholder:"邀请码（可为空）","auto-complete":"off"},model:{value:t.form.inviteCode,callback:function(e){t.$set(t.form,"inviteCode","string"==typeof e?e.trim():e)},expression:"form.inviteCode"}}),t._v(" "),n("VButton",{attrs:{slot:"submit",loading:t.submitBtnLoading,disabled:t.submitBtnDisabled,size:"large",block:"",round:""},slot:"submit"},[t._v("\n      "+t._s(t.submitBtnText)+"\n      "),t.timeout?[t._v(" （"+t._s(t.timeout)+"s 后可重新获取） ")]:t._e()],2)],1),t._v(" "),n("div",{staticClass:"others"},[n("ul",{staticClass:"provider"},[n("span",[t._v("社交账号注册")]),t._v(" "),n("li",{on:{click:t.qqRegisterLink}},[n("i",{staticClass:"iconfont ic-qq"})]),t._v(" "),n("li",{on:{click:t.wechatRegisterLink}},[n("i",{staticClass:"iconfont ic-v-chat"})])]),t._v(" "),t.inviteCode?t._e():n("a",{on:{click:t.showLogin}},[t._v("已有账号»")])])],1)}),[],!1,null,null,null).exports),E={name:"ResetPasswordForm",components:{VForm:$.a,VButton:v.a,VField:d.a},data:function(){return{form:{access:"",secret:"",authCode:""},rule:{access:[{validator:function(t,e,n){return e?11!==e.length?n(new Error("请填写11位手机号")):void n():n(new Error("请填写手机号"))},trigger:"blur"}],secret:[{validator:function(t,e,n){return""===e?n(new Error("请填写登录密码")):e.length<6?n(new Error("密码不能小于6位")):e.length>16?n(new Error("密码不能大于16位")):void n()},trigger:"blur"}]},step:0,timeout:0}},computed:{submitBtnText:function(){return 0===this.step?"立即重置":1===this.step?"提交中...":2===this.step?"短信已发送":3===this.step?"已重置":"立即重置"},submitBtnLoading:function(){return 1===this.step||3===this.step},submitBtnDisabled:function(){return 0!==this.timeout&&0===this.step||3===this.step}},methods:{submitForm:function(){0===this.step&&this.getResetAuthCode(),2===this.step&&this.openConfirmModal()},getResetAuthCode:(c=Object(R.a)(regeneratorRuntime.mark((function t(){var e,n=this;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.step=1,t.prev=1,t.next=4,Object(k.h)(this,{type:"forgot_password",phone_number:this.form.access});case 4:this.step=2,this.openConfirmModal(),t.next=12;break;case 8:t.prev=8,t.t0=t.catch(1),this.$toast.error(t.t0.message),this.step=0;case 12:return t.prev=12,this.timeout=60,e=setInterval((function(){--n.timeout||(n.step=0,clearInterval(e))}),1e3),t.finish(12);case 16:case"end":return t.stop()}}),t,this,[[1,8,12,16]])}))),function(){return c.apply(this,arguments)}),openConfirmModal:function(){var t=this;this.$prompt("请输入收到的验证码","短信已发送",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/^\d{6}$/,inputErrorMessage:"验证码格式不正确"}).then((function(e){var n=e.value;t.form.authCode=n,t.step=3,t.signReset()})).catch((function(){}))},signReset:(r=Object(R.a)(regeneratorRuntime.mark((function t(){var e;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,Object(k.g)(this,{access:this.form.access,authCode:this.form.authCode,secret:this.form.secret});case 3:e=t.sent,this.$toast.success(e),this.showLogin(),t.next=11;break;case 8:t.prev=8,t.t0=t.catch(0),this.$toast.error(t.t0.message);case 11:return t.prev=11,this.step=0,t.finish(11);case 14:case"end":return t.stop()}}),t,this,[[0,8,11,14]])}))),function(){return r.apply(this,arguments)}),showLogin:function(){this.$emit("to-login")},showRegister:function(){this.$emit("to-register")}}},F=(n(285),{name:"SignDialog",components:{SignUpForm:S,SignInForm:y,ResetPasswordForm:Object(C.a)(E,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"reset-password-form"},[n("VForm",{attrs:{loading:t.submitBtnLoading,form:t.form,rule:t.rule},on:{submit:t.submitForm}},[n("VField",{attrs:{type:"text",placeholder:"手机号","auto-complete":"off"},model:{value:t.form.access,callback:function(e){t.$set(t.form,"access","string"==typeof e?e.trim():e)},expression:"form.access"}}),t._v(" "),n("VField",{attrs:{type:"text",placeholder:"新密码","auto-complete":"off"},model:{value:t.form.secret,callback:function(e){t.$set(t.form,"secret","string"==typeof e?e.trim():e)},expression:"form.secret"}}),t._v(" "),n("VButton",{attrs:{slot:"submit",loading:t.submitBtnLoading,disabled:t.submitBtnDisabled,size:"large",block:"",round:""},slot:"submit"},[t._v("\n      "+t._s(t.submitBtnText)+"\n      "),t.timeout?[t._v(" （"+t._s(t.timeout)+"s 后可重新获取） ")]:t._e()],2)],1),t._v(" "),n("div",{staticClass:"others"},[n("a",{on:{click:t.showLogin}},[t._v("返回登录>")]),t._v(" "),n("a",{on:{click:t.showRegister}},[t._v("点击注册»")])])],1)}),[],!1,null,null,null).exports},data:function(){return{canRender:!1,showModal:!1,showSignIn:!1,showSignUp:!1,showReset:!1}},computed:{isGuest:function(){return!this.$store.state.isAuth}},mounted:function(){var t=this;this.canRender=!0,this.$channel.$on("sign-in",(function(){window.screen.width<=768?window.location.href=t.$alias.sign():t.showLogin()})),this.$channel.$on("sign-up",(function(){t.showRegister()}))},methods:{showLogin:function(){this.showReset=!1,this.showModal=!0,this.showSignIn=!0,this.showSignUp=!1},showRegister:function(){this.showModal=!0,this.showSignUp=!0,this.showSignIn=!1},hiddenSign:function(){this.showModal=!1,this.showSignIn=!1,this.showSignUp=!1,this.showReset=!1}}}),O=(n(286),{beforeMount:function(){var t=this;this.$channel.$when("user-signed",(function(){var e=function(){return Date.now()-t.$cache.get("socket-connect-heartbeat",0)<=1e3};setTimeout((function(){var n,o=function(){t.$channel.socketConnect();var e=setInterval((function(){t.$store.state.socket.isConnected?t.$cache.set("socket-connect-heartbeat",Date.now()):clearInterval(e)}),1e3);window.addEventListener("beforeunload",(function(){t.$channel.socketDisconnect()}))};e()||"visible"!==document.visibilityState?(t.$store.commit("SOCKET_AUTO_CONNECT"),n=setInterval((function(){e()?Date.now()-t.$cache.get("socket-on-message-time",0)<=1e3&&t.$store.commit("SOCKET_ONMESSAGE",t.$cache.get("socket-on-message-data")):"visible"===document.visibilityState&&(o(),clearInterval(n))}),2e3)):o()}),2e3)}))},beforeDestroy:function(){this.$store.state.socket.isConnected&&this.$channel.socketDisconnect()}}),I={name:"Layout",components:{SignDialog:Object(C.a)(F,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return t.canRender?n("div",{staticClass:"sign-container"},[t.isGuest?n("div",{class:[t.showModal?"space-enter":"space-leave"],attrs:{id:"space3D"},on:{click:t.hiddenSign}},[n("div",{ref:"wrap",staticClass:"sign-modal-wrap"},[n("div",{staticClass:"sign-modal sign-in-modal",class:{"sign-in-init":!t.showSignIn&&!t.showSignUp,"sign-in-show":t.showSignIn&&!t.showSignUp,"sign-in-turn":!t.showSignIn&&t.showSignUp},on:{click:function(t){t.stopPropagation()}}},[n("div",{staticClass:"sign-logo"}),t._v(" "),n("ResetPasswordForm",{directives:[{name:"show",rawName:"v-show",value:t.showReset,expression:"showReset"}],on:{"to-login":function(e){t.showReset=!1},"to-register":t.showRegister}}),t._v(" "),n("SignInForm",{directives:[{name:"show",rawName:"v-show",value:!t.showReset,expression:"!showReset"}],on:{"to-reset":function(e){t.showReset=!0},"to-register":t.showRegister}})],1),t._v(" "),n("div",{staticClass:"sign-modal sign-up-modal",class:{"sign-up-init":!t.showSignUp&&!t.showSignIn,"sign-up-show":t.showSignUp&&!t.showSignIn,"sign-up-turn":!t.showSignUp&&t.showSignIn},on:{click:function(t){t.stopPropagation()}}},[n("div",{staticClass:"sign-logo"}),t._v(" "),n("SignUpForm",{on:{"to-login":t.showLogin}})],1)])]):t._e()]):t._e()}),[],!1,null,null,null).exports},mixins:[n(248).a,O]},B=Object(C.a)(I,(function(){var t=this.$createElement,e=this._self._c||t;return e("div",{attrs:{id:"layout-web"}},[e("nuxt"),this._v(" "),e("SignDialog")],1)}),[],!1,null,null,null);e.default=B.exports}}]);